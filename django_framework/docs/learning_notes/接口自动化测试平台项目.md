## 一、基础阶段

### 1. 创建Django项目

- 执行命令```django-admin startproject api_platform .``` ```api_platform```为Django项目名称，```.```为当前目录创建 
- 项目结构

```shell
.
├── api_platform	#.为该目录，创建与该目录名称相同的项目
│   ├── api_platform	#该目录及以下目录文件为自动生成的项目文件
│   │   ├── asgi.py
│   │   ├── __init__.py
│   │   ├── __pycache__
│   │   │   ├── __init__.cpython-37.pyc
│   │   │   ├── settings.cpython-37.pyc
│   │   │   ├── urls.cpython-37.pyc
│   │   │   └── wsgi.cpython-37.pyc
│   │   ├── settings.py
│   │   ├── urls.py
│   │   └── wsgi.py
│   ├── db.sqlite3
│   └── manage.py
```

### 2. 配置settings.py

```python
"""
Django settings for api_platform project.

Generated by 'django-admin startproject' using Django 3.0.3.

For more information on this file, see
https://docs.djangoproject.com/en/3.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.0/ref/settings/
"""

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = '&q5@i4z6pg)l#9p!yjutkwoguwi&-rd!v&o)bj01=adad%k=#h'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

# 设置允许访问的主机
ALLOWED_HOSTS = ['*']

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    # 临时关闭csr安全校验
    # 'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'api_platform.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'api_platform.wsgi.application'

# Database
# https://docs.djangoproject.com/en/3.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}

# Password validation
# https://docs.djangoproject.com/en/3.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME':
        'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME':
        'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME':
        'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME':
        'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# Internationalization
# https://docs.djangoproject.com/en/3.0/topics/i18n/

# 设置语言
LANGUAGE_CODE = 'zh-hans'

# 设置时区
TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = True

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.0/howto/static-files/

STATIC_URL = '/static/'

```

### 3. 指定IP和端口运行项目

- 执行命令```python manage.py runserver 0:8010```

```shell
(dev)  api_platform (master) ✗ python manage.py runserver 0:8010
Watching for file changes with StatReloader
Performing system checks...

System check identified no issues (0 silenced).

You have 17 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, auth, contenttypes, sessions.
Run 'python manage.py migrate' to apply them.

March 29, 2020 - 06:54:01
Django version 3.0.3, using settings 'api_platform.settings'
Starting development server at http://0:8010/
Quit the server with CONTROL-C.
```



### 4.迁移数据

- Ctrl 退出运行
- 执行命令```python manage.py migrate```

```zsh
^C#                                                                                                                                                                                        
(dev)  api_platform (master) ✗ python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK
(dev)  api_platform (master) ✗ 
```

### 5. 再次启动项目

- 执行命令```python manage.py runserver 0:8010```

```shell
~/pysdev/python_course/api_platform_course/api_platform(master*) # python manage.py runserver 0:8010                                                                    root@VM_0_6_centos
Watching for file changes with StatReloader
Performing system checks...

System check identified no issues (0 silenced).
March 29, 2020 - 15:07:47
Django version 3.0.3, using settings 'api_platform.settings'
Starting development server at http://0:8010/
```

### 6. 开通访问端口和指定域名

- 域名管理中解析指定域名到云服务器

- 开通云服务器端口

  - 云服务器提供商开启端口
  - 服务器开启本地端口

  ```shell
  # 1.查看自己的防火墙公告端口是否有你设置的端口，代码如下
  firewall-cmd --zone=public --list-ports
  
  # 2.添加需要的端口如（8000）
  firewall-cmd --zone=public --add-port=8000/tcp --permanent
  
  # 3.重启即可
  firewall-cmd --reload
  
  # 拓展
  # 添加范围例外端口,如:5000-10000
  firewall-cmd --zone=public --add-port=5000-10000/tcp --permanent
  
  # 查看单独端口
  firewall-cmd --zone=public --query-port=80/tcp
  
  # 删除
  firewall-cmd --zone=public --remove-port=80/tcp --permanent
  
  ```

### 7. 打开网页输入域名

-  http://api.pysdev.com:8010/ 

![1585466412308](%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE.assets/1585466412308.png)

### 8. 安装和配置DRF框架

- 使用pip安装django rest framework 

```python
pip install djangorestframework
pip install markdown       # Markdown support for the browsable API.
pip install django-filter  # Filtering support
```

- 添加到您的设置。`'rest_framework'``INSTALLED_APPS`

```python
# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'projects.apps.ProjectsConfig',
    'interfaces.apps.InterfacesConfig',
    'users.apps.UsersConfig',
    'rest_framework',	#作为应用添加到全部配置文件
]
```

### 9. 创建子应用

- ```python manage.py startapp projects```

![1585466585750](%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE.assets/1585466585750.png)

### 10. 配置子应用

- 全局配置增加子应用

```python
# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # projects为应用名称，ProjectsConfig首字母大写
    'projects.apps.ProjectsConfig',
]
```

- 配置全局路由和子路由

  - 全局路

  ```python
  """api_platform URL Configuration
  
  The `urlpatterns` list routes URLs to views. For more information please see:
      https://docs.djangoproject.com/en/3.0/topics/http/urls/
  Examples:
  Function views
      1. Add an import:  from my_app import views
      2. Add a URL to urlpatterns:  path('', views.home, name='home')
  Class-based views
      1. Add an import:  from other_app.views import Home
      2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
  Including another URLconf
      1. Import the include() function: from django.urls import include, path
      2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
  """
  from django.contrib import admin
  from django.urls import path, include
  
  urlpatterns = [
      path('admin/', admin.site.urls),
      path('projects/', include('projects.urls')),
  ]
  
  ```

  - 子路由

  ```python
  """api_platform URL Configuration
  
  The `urlpatterns` list routes URLs to views. For more information please see:
      https://docs.djangoproject.com/en/3.0/topics/http/urls/
  Examples:
  Function views
      1. Add an import:  from my_app import views
      2. Add a URL to urlpatterns:  path('', views.home, name='home')
  Class-based views
      1. Add an import:  from other_app.views import Home
      2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
  Including another URLconf
      1. Import the include() function: from django.urls import include, path
      2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
  """
  
  from django.urls import path
  from . import views
  
  urlpatterns = [
      path('', views.Index.as_view()),
  ]
  
  ```

### 11. 编写子应用相关功能

- 在django_views/views.py中创建相关功能（函数视图或者）

**函数视**

```python
from django.http import HttpResponse


# 函数视图
def index(request):
    return HttpResponse("<h1>Hello World</h1>")
```

**类视图**

```python
from django.http import HttpResponse
from django.views import View


# 类视图,同时需要导入View
class HomeIndex(View):
    def get(self, request):
        return HttpResponse("<h1>Hello World</h1>")
```

### 12. 再次启动项目

- 执行命令```python manage.py runserver 0:8010```

![1585468274306](%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE.assets/1585468274306.png)

## 二、进阶阶段

### 1. 创建应用合集apps

- 项目根目录创建apps目录
- 将多个应用放入apps统一管理，简化结构

```python
import os
import sys

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# 将apps设为根目录，下面两个二选一
sys.path.append(os.path.join(BASE_DIR, "apps"))
# sys.path.insert(0,os.path.join(BASE_DIR,"apps"))
```

### 2. 创建users子应用

- 按正常方式在根目录中创建users子应用，然后将users移到apps目录下

### 3. 修改全局配置文件

- 全局配置setting.py文件添加users子应用

```python
# Application definition

INSTALLED_APPS = [
    ···
    'Users.apps.UsersConfig',
]
```

- 覆盖REST_FRAMEWORK(DRF)默认配置，自定义认证和授权

```python
# REST_FRAMEWORK(DRF)覆盖默认配置
REST_FRAMEWORK = {
    # 默认响应渲染类
    'DEFAULT_RENDERER_CLASSES': (
        # json渲染类为第一条优先
        'rest_framework.renderers.JSONRenderer',
        # 可浏览的API渲染器为第二优先级
        'rest_framework.renderers.BrowsableAPIRenderer',
    ),

    # 全局指定过滤引擎类
    'DEFAULT_FILTER_BACKENDS': [
        # 过滤引擎
        'django_filters.rest_framework.backends.DjangoFilterBackend',
        # 排序引擎
        'rest_framework.filters.OrderingFilter'
    ],

    # 全局指定分页引擎类
    # 'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'DEFAULT_PAGINATION_CLASS':
    'utils.pagination.ManualPageNumberPagination',
    'PAGE_SIZE':
    3,

    # 指定用于支持coreapi的Schema
    'DEFAULT_SCHEMA_CLASS':
    'rest_framework.schemas.coreapi.AutoSchema',

    # 指定认证类(指定的是认证的方式)
    'DEFAULT_AUTHENTICATION_CLASSES': [
        # 指定使用JWT Token认证
        'rest_framework_jwt.authentication.JSONWebTokenAuthentication',
        # DRF框架默认情况下, 使用的是用户会话认证
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.BasicAuthentication'
    ],

    # 授权类(指定的是认证成功之后能干嘛!)
    'DEFAULT_PERMISSION_CLASSES': [
        # DRF框架默认的权限为AllowAny(允许所有用户来访问)
        'rest_framework.permissions.IsAuthenticated',
    ],
}
```

- 配置数据库

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',  # 数据库引擎
        'NAME': 'api_platform_stg',  # 数据库名
        'USER': 'api_platform_stg',  # 数据库用户名
        'PASSWORD': 'BjbrmnG2Z6Ym6pCG',  # 数据库密码
        'HOST': '111.229.64.99',  # 数据库主机域名或者IP
        'PORT': 3306  # 数据库端口
    }
}
```

- 迁移数据库

  ```python manage.py migrate```

```python
(dev) VM_0_6_centos:api_platform:# python manage.py migrate                                                                                                                 <master ✗>
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK
(dev) VM_0_6_centos:api_platform:#  
```

### 4. 配置projects子应用

- 编写models.py
- 编写serializers.py
- 编写views.py
- 准备迁移数据和迁移

```python
python manage.py makemigrations # 准备迁移数据
python manage.py migrate # 迁移数据
```

- 导入数据
- 浏览器打开查询页面

![1585507716282](%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE.assets/1585507716282.png)

![1585507773175](%E6%8E%A5%E5%8F%A3%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE.assets/1585507773175.png)